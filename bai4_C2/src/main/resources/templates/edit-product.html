<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·ª≠a S·∫£n Ph·∫©m</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="/styles.css" rel="stylesheet">
    <style>
        body { background: #f5f7fa !important; }
        .form-container { max-width: 700px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .image-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; }
        .form-section { padding: 40px 30px; }
        @media (max-width: 768px) {
            .form-container { margin: 10px auto; }
            .image-section { padding: 30px 20px; }
            .form-section { padding: 30px 20px; }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <!-- Image Upload Section -->
        <div class="image-section">
            <!-- ·∫¢nh Hi·ªán T·∫°i -->
            <div th:if="${product.image}" style="margin-bottom: 25px;">
                <h3 style="color: white; margin-bottom: 15px; text-align: center; font-size: 1.1em; font-weight: 600;">üì∑ ·∫¢nh Hi·ªán T·∫°i</h3>
                <div style="background: white; padding: 15px; border-radius: 5px; text-align: center;">
                    <img th:src="@{/uploads/{image}(image=${product.image})}" alt="Current Product Image" style="max-width: 100%; max-height: 150px; border-radius: 5px; margin-bottom: 10px;">
                    <p th:text="${product.image}" style="margin: 0; color: #667eea; font-weight: 600; font-size: 0.85em; word-break: break-all;"></p>
                </div>
            </div>

            <!-- Ch·ªçn ·∫¢nh M·ªõi -->
            <div>
                <h3 style="color: white; margin-bottom: 15px; text-align: center; font-size: 1.1em; font-weight: 600;">üñºÔ∏è T·∫£i H√¨nh ·∫¢nh M·ªõi</h3>
                <div id="dropZone" class="file-upload-zone">
                    <div id="dropText">
                        <p style="font-size: 3em; margin-bottom: 15px; line-height: 1;">üìÅ</p>
                        <p style="font-size: 1.05em; margin-bottom: 8px; font-weight: 600; color: #333;">K√©o th·∫£ h√¨nh ·∫£nh ho·∫∑c nh·∫•p ƒë·ªÉ ch·ªçn</p>
                        <p style="font-size: 0.9em; color: #666;">JPG, PNG, GIF | T·ªëi ƒëa 200 k√≠ t·ª± t√™n file</p>
                    </div>
                    <div id="imagePreview" style="display: none; text-align: center;">
                        <img id="previewImage" src="" alt="Preview" style="max-width: 100%; max-height: 250px; border-radius: 8px; margin-bottom: 15px; border: 3px solid white;">
                        <p id="fileName" style="color: white; font-weight: 600; font-size: 0.95em; margin-bottom: 10px; word-break: break-all;"></p>
                        <button type="button" onclick="clearImage()" style="background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; border: 2px solid white; border-radius: 5px; cursor: pointer; font-weight: 600; transition: none;">üóëÔ∏è Ch·ªçn L·∫°i</button>
                    </div>
                    <input type="file" id="file" name="file" accept="image/*" style="display: none;">
                </div>
            </div>
        </div>

        <div class="form-section">
            <h1 style="color: #667eea; margin-bottom: 30px; font-size: 1.8em; text-align: center; font-weight: 700;">‚úèÔ∏è S·ª≠a S·∫£n Ph·∫©m</h1>
            <div th:if="${error}" class="error-alert" th:text="${error}"></div>

            <form method="post" enctype="multipart/form-data" th:action="@{/products/edit/{id}(id=${product.id})}" th:object="${product}" novalidate>
                <!-- M√£ S·∫£n Ph·∫©m -->
                <div class="form-group" th:classappend="${#fields.hasErrors('code')} ? 'has-error' : null">
                    <label for="code"><strong>M√£ S·∫£n Ph·∫©m</strong> <span class="required">*</span></label>
                    <input type="text" id="code" name="code" th:value="${product.code}" placeholder="VD: SP001" required>
                    <span th:if="${#fields.hasErrors('code')}" class="error-message" th:errors="*{code}"></span>
                </div>

                <!-- T√™n S·∫£n Ph·∫©m -->
                <div class="form-group" th:classappend="${#fields.hasErrors('name')} ? 'has-error' : null">
                    <label for="name"><strong>T√™n S·∫£n Ph·∫©m</strong> <span class="required">*</span></label>
                    <input type="text" id="name" name="name" th:value="${product.name}" placeholder="VD: iPhone 15" required>
                    <span th:if="${#fields.hasErrors('name')}" class="error-message" th:errors="*{name}"></span>
                </div>

                <!-- Gi√° S·∫£n Ph·∫©m -->
                <div class="form-group" th:classappend="${#fields.hasErrors('price')} ? 'has-error' : null">
                    <label for="price"><strong>Gi√° S·∫£n Ph·∫©m</strong> <span class="required">*</span> (ƒë)</label>
                    <input type="number" id="price" name="price" th:value="${product.price}" min="1" max="9999999" placeholder="VD: 25000000" required>
                    <span th:if="${#fields.hasErrors('price')}" class="error-message" th:errors="*{price}"></span>
                </div>

                <!-- Danh M·ª•c -->
                <div class="form-group" th:classappend="${#fields.hasErrors('category')} ? 'has-error' : null">
                    <label for="category"><strong>Lo·∫°i Danh M·ª•c</strong> <span class="required">*</span></label>
                    <select id="category" name="category" required>
                        <option value="">-- Ch·ªçn danh m·ª•c --</option>
                        <option th:each="cat : ${categories}" th:value="${cat.name}" th:text="${cat.name}" th:selected="${product.category == cat.name}"></option>
                    </select>
                    <span th:if="${#fields.hasErrors('category')}" class="error-message" th:errors="*{category}"></span>
                </div>

                <!-- N√∫t H√†nh ƒê·ªông -->
                <div class="button-group" style="margin-top: 35px;">
                    <button type="submit" class="btn-submit" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; font-weight: 600; letter-spacing: 0.5px;">üíæ C·∫≠p Nh·∫≠t</button>
                    <button type="button" class="btn-cancel" onclick="window.location.href='/products'" style="background: #e8e8e8; border: none; font-weight: 600; letter-spacing: 0.5px;">‚ùå H·ªßy</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('file');
        const dropText = document.getElementById('dropText');
        const imagePreview = document.getElementById('imagePreview');
        const previewImage = document.getElementById('previewImage');
        const fileName = document.getElementById('fileName');

        // Click ƒë·ªÉ ch·ªçn file
        dropZone.addEventListener('click', () => fileInput.click());

        // Drag-drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.background = '#ede7f6';
            dropZone.style.borderColor = '#764ba2';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.background = '#f5f5f5';
            dropZone.style.borderColor = '#667eea';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.background = '#f5f5f5';
            dropZone.style.borderColor = '#667eea';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        });

        // File input change
        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewImage.src = e.target.result;
                        fileName.textContent = file.name;
                        dropText.style.display = 'none';
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh!');
                    fileInput.value = '';
                }
            }
        }

        function clearImage() {
            fileInput.value = '';
            dropText.style.display = 'block';
            imagePreview.style.display = 'none';
        }

        // Prevent browser from opening file when dropped on page
        document.addEventListener('dragover', (e) => e.preventDefault());
        document.addEventListener('drop', (e) => e.preventDefault());
    </script>
</body>
</html>
